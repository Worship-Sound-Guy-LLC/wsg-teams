<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WSG | CENTRAL ‚Äî Team Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #111111;
      color: #fff;
      min-height: 100vh;
    }
    .header {
      background: #1a1a1a;
      border-bottom: 1px solid #2a2a2a;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header img { height: 28px; width: auto; }
    .header-right { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
    .user-email { font-size: 0.8rem; color: #666; }
    .signout-btn {
      background: transparent;
      color: #999;
      border: 1px solid #333;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }
    .signout-btn:hover { border-color: #666; color: white; }
    .container { max-width: 700px; margin: 0 auto; padding: 32px 16px; }
    .card {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }
    .btn {
      display: inline-block;
      padding: 10px 18px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      text-align: center;
    }
    .btn-primary { background: #1a8cff; color: white; }
    .btn-primary:hover { background: #0077ee; }
    .btn-copy { background: #2a2a2a; color: #ccc; font-size: 0.82rem; padding: 7px 14px; }
    .btn-copy:hover { background: #333; color: white; }
    .btn-remove { background: transparent; color: #ff4444; border: 1px solid #3a1a1a; font-size: 0.8rem; padding: 5px 12px; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
    .btn-remove:hover { background: #2a1010; }
    .team-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
    .team-title { font-size: 1.2rem; font-weight: 700; color: #ffffff; }
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.03em;
    }
    .badge-subscription { background: #0d2a4a; color: #1a8cff; }
    .badge-course { background: #0d3320; color: #22c55e; }
    .seats-bar-wrap { margin-bottom: 20px; }
    .seats-label { font-size: 0.85rem; color: #cccccc; margin-bottom: 8px; font-weight: 500; }
    .seats-bar { background: #2a2a2a; border-radius: 99px; height: 6px; overflow: hidden; }
    .seats-fill { background: #1a8cff; height: 100%; border-radius: 99px; transition: width 0.4s; }
    .seats-fill.full { background: #ff4444; }
    .invite-section { background: #111; border: 1px solid #2a2a2a; border-radius: 8px; padding: 16px; margin-bottom: 20px; }
    .invite-label { font-size: 0.75rem; color: #ffffff; margin-bottom: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; }
    .invite-link-row { display: flex; gap: 8px; align-items: center; }
    .invite-link-text {
      flex: 1;
      font-size: 0.82rem;
      color: #1a8cff;
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
      padding: 8px 12px;
      word-break: break-all;
    }
    .section-label { font-size: 0.75rem; font-weight: 700; color: #ffffff; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.08em; }
    .member-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #222;
    }
    .member-row:last-child { border-bottom: none; }
    .member-info { display: flex; flex-direction: column; gap: 4px; }
    .member-email { font-size: 0.95rem; color: #ffffff; font-weight: 500; }
    .member-status {
      font-size: 0.72rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 20px;
      display: inline-block;
      width: fit-content;
      letter-spacing: 0.03em;
    }
    .invited { background: #2a2200; color: #f59e0b; }
    .viewed  { background: #0d2040; color: #60a5fa; }
    .active  { background: #0d2a18; color: #22c55e; }
    .empty-members { color: #888; font-size: 0.9rem; text-align: center; padding: 20px 0; }
    .error-msg { color: #ff4444; font-size: 0.85rem; margin-top: 8px; }
    .loading { text-align: center; color: #555; padding: 60px; }
    .add-member-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid #222; }
    .add-member-row { display: flex; gap: 8px; }
    .add-member-row input[type="email"] {
      flex: 1;
      padding: 10px 14px;
      background: #111;
      border: 1px solid #333;
      border-radius: 8px;
      font-size: 0.95rem;
      color: white;
      outline: none;
      transition: border-color 0.2s;
    }
    .add-member-row input[type="email"]::placeholder { color: #444; }
    .add-member-row input[type="email"]:focus { border-color: #1a8cff; }
    .copied { color: #22c55e; font-size: 0.8rem; margin-top: 6px; }

    /* No team state */
    .no-team-card { text-align: center; padding: 56px 24px; }
    .no-team-icon { font-size: 3rem; margin-bottom: 20px; }
    .no-team-card h3 { font-size: 1.4rem; font-weight: 700; margin-bottom: 12px; }
    .no-team-card p { color: #888; font-size: 0.95rem; line-height: 1.7; max-width: 400px; margin: 0 auto 28px; }
    .btn-upgrade {
      background: #1a8cff;
      color: white;
      padding: 14px 32px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 700;
      text-decoration: none;
      display: inline-block;
      transition: background 0.2s;
      letter-spacing: 0.02em;
    }
    .btn-upgrade:hover { background: #0077ee; }
    .support-link { display: block; margin-top: 16px; font-size: 0.83rem; color: #555; }
    .support-link a { color: #1a8cff; text-decoration: none; }
    .support-link a:hover { text-decoration: underline; }
    .btn-sync { background: #1a1a1a; color: #888; border: 1px solid #333; font-size: 0.82rem; padding: 7px 14px; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
    .btn-sync:hover { border-color: #1a8cff; color: #1a8cff; }
  </style>
</head>
<body>

<div class="header">
  <img src="/WSG_Central_Logo_lite.png" alt="WSG | CENTRAL" />
  <div class="header-right">
    <span class="user-email" id="userEmailDisplay"></span>
    <button class="signout-btn" id="signoutBtn">Sign Out</button>
  </div>
</div>

<div class="container">
  <div class="loading" id="loadingState">Loading your team...</div>
  <div id="teamsContainer"></div>
</div>

<script>
  const SUPABASE_URL = 'https://ptofajaxaopzdwtfvfhq.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_pbucGPyxVzuK77Q3n62QNA_F8x0SzY_';
  const API_BASE = '/api';

  function getStatusLabel(status) {
    if (status === 'active') return '‚úì Active';
    if (status === 'viewed') return 'üëÄ Viewed invite';
    return 'üìß Invite sent';
  }

  let currentSession = null;

  window.addEventListener('load', async function() {
    const hash = window.location.hash;
    if (hash && hash.includes('access_token')) {
      await handleAuthCallback(hash);
    } else {
      await checkSession();
    }
  });

  async function handleAuthCallback(hash) {
    const params = new URLSearchParams(hash.substring(1));
    const accessToken = params.get('access_token');
    const refreshToken = params.get('refresh_token');
    if (accessToken) {
      sessionStorage.setItem('wsg_access_token', accessToken);
      sessionStorage.setItem('wsg_refresh_token', refreshToken);
      window.history.replaceState({}, document.title, window.location.pathname);
      await loadDashboard(accessToken);
    } else {
      redirectToLogin();
    }
  }

  async function checkSession() {
    const accessToken = sessionStorage.getItem('wsg_access_token');
    if (!accessToken) { redirectToLogin(); return; }
    await loadDashboard(accessToken);
  }

  async function loadDashboard(accessToken) {
    try {
      const userRes = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${accessToken}` }
      });
      if (!userRes.ok) { redirectToLogin(); return; }

      const user = await userRes.json();
      const email = user.email;
      currentSession = { accessToken, email };
      document.getElementById('userEmailDisplay').textContent = email;

      const res = await fetch(`${API_BASE}/dashboard?email=${encodeURIComponent(email)}`);
      const data = await res.json();
      document.getElementById('loadingState').style.display = 'none';

      if (!res.ok || !data.teams || data.teams.length === 0) {
        document.getElementById('teamsContainer').innerHTML = `
          <div class="card no-team-card">
            <div class="no-team-icon">üë•</div>
            <h3>No active team subscription found</h3>
            <p>We couldn't find an active WSG Central team subscription for <strong>${email}</strong>. Get started by purchasing a team plan.</p>
            <a href="https://worshipsoundguy.com/central/" class="btn-upgrade">View Team Plans ‚Üí</a>
            <span class="support-link">Already purchased? <a href="mailto:support@worshipsoundguy.com">Contact support</a></span>
          </div>`;
        return;
      }

      renderTeams(data.teams, email);
    } catch (err) {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('teamsContainer').innerHTML = `
        <div class="card no-team-card">
          <div class="no-team-icon">‚ö†Ô∏è</div>
          <h3>Something went wrong</h3>
          <p>Please try refreshing the page or signing in again.</p>
        </div>`;
    }
  }

  function renderTeams(teams, leaderEmail) {
    const container = document.getElementById('teamsContainer');
    container.innerHTML = '';

    teams.forEach(function(team) {
      const pct = Math.round((team.seatsUsed / team.seatLimit) * 100);
      const isFull = team.seatsUsed >= team.seatLimit;
      const badgeClass = team.accessType === 'subscription' ? 'badge-subscription' : 'badge-course';
      const badgeLabel = team.accessType === 'subscription' ? 'Subscription Team' : 'Course Team';

      const membersHTML = team.members.length === 0
        ? '<div class="empty-members">No members added yet. Share your invite link or add members below!</div>'
        : team.members.map(function(m) {
            return '<div class="member-row">' +
              '<div class="member-info">' +
                '<div class="member-email">' + m.email + '</div>' +
                '<div class="member-status ' + (m.invite_status || 'invited') + '">' + getStatusLabel(m.invite_status) + '</div>' +
              '</div>' +
              '<button class="btn-remove" data-team="' + team.id + '" data-email="' + m.email + '">Remove</button>' +
            '</div>';
          }).join('');

      const syncButton = '<button class="btn btn-sync" data-sync-team="' + team.id + '">‚Üª Sync Status</button>';
      const addMemberSection = !isFull
        ? '<div class="add-member-section">' +
            '<div class="section-label">Add a Member by Email</div>' +
            '<div class="add-member-row">' +
              '<input type="email" id="addEmail-' + team.id + '" placeholder="member@email.com" />' +
              '<button class="btn btn-primary" data-add-team="' + team.id + '" data-token="' + (team.inviteLink ? team.inviteLink.split('token=')[1] : '') + '">Add</button>' +
            '</div>' +
            '<div class="error-msg" id="addError-' + team.id + '"></div>' +
          '</div>'
        : '<div class="add-member-section"><p style="color:#ff4444;font-size:0.85rem;">‚ö†Ô∏è Team is full. Contact support to add more seats.</p></div>';

      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML =
        '<div class="team-header">' +
          '<div class="team-title">' + badgeLabel + '</div>' +
          '<span class="badge ' + badgeClass + '">' + team.seatsUsed + '/' + team.seatLimit + ' seats used</span>' +
        '</div>' +
        '<div class="seats-bar-wrap">' +
          '<div class="seats-label">' + (isFull ? '‚ö†Ô∏è Team is full' : team.seatsRemaining + ' seat' + (team.seatsRemaining !== 1 ? 's' : '') + ' remaining') + '</div>' +
          '<div class="seats-bar"><div class="seats-fill ' + (isFull ? 'full' : '') + '" style="width:' + pct + '%"></div></div>' +
        '</div>' 
        '<div class="invite-section">' +
          '<div class="invite-label">Your Invite Link</div>' +
          '<div class="invite-link-row">' +
            '<div class="invite-link-text" id="link-' + team.id + '">' + (team.inviteLink || 'No invite link available') + '</div>' +
            '<button class="btn btn-copy" data-copy="' + team.id + '">Copy</button>' +
          '</div>' +
          '<div class="copied" id="copied-' + team.id + '" style="display:none">‚úì Copied!</div>' +
        '</div>' +
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">' +
        '<div class="section-label" style="margin-bottom:0;">Team Members</div>' +
        '<button class="btn btn-sync" data-sync-team="' + team.id + '">‚Üª Check Status</button>' +
          '</div>' +
        '<div id="members-' + team.id + '">' + membersHTML + '</div>' +
        addMemberSection;

      container.appendChild(card);
    });

    container.querySelectorAll('[data-sync-team]').forEach(function(btn) {
    btn.addEventListener('click', function() { syncStatus(btn.getAttribute('data-sync-team'), btn); });
    });
    container.querySelectorAll('[data-copy]').forEach(function(btn) {
      btn.addEventListener('click', function() { copyLink(btn.getAttribute('data-copy')); });
    });
    container.querySelectorAll('[data-add-team]').forEach(function(btn) {
      btn.addEventListener('click', function() { addMember(btn.getAttribute('data-add-team'), btn.getAttribute('data-token')); });
    });
    container.querySelectorAll('[data-team]').forEach(function(btn) {
      btn.addEventListener('click', function() { removeMember(btn.getAttribute('data-team'), btn.getAttribute('data-email')); });
    });
  }

  async function addMember(teamId, token) {
    const emailInput = document.getElementById('addEmail-' + teamId);
    const errorEl = document.getElementById('addError-' + teamId);
    const email = emailInput.value.trim();
    errorEl.textContent = '';
    if (!email) { errorEl.textContent = 'Please enter an email.'; return; }
    try {
      const res = await fetch(API_BASE + '/invite', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: token, memberEmail: email, addedByLeader: true })
      });
      const data = await res.json();
      if (!res.ok) { errorEl.textContent = data.error; return; }
      await loadDashboard(currentSession.accessToken);
    } catch (e) {
      errorEl.textContent = 'Something went wrong. Please try again.';
    }
  }

  async function removeMember(teamId, memberEmail) {
    if (!confirm('Remove ' + memberEmail + ' from this team?')) return;
    try {
      const res = await fetch(API_BASE + '/remove-member', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ teamId: teamId, memberEmail: memberEmail })
      });
      if (res.ok) await loadDashboard(currentSession.accessToken);
    } catch (e) { alert('Something went wrong. Please try again.'); }
  }

  async function syncStatus(teamId, btn) {
  btn.textContent = 'Syncing...';
  btn.disabled = true;
  try {
    const res = await fetch(API_BASE + '/sync-status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ teamId: teamId })
    });
    const data = await res.json();
    await loadDashboard(currentSession.accessToken);
  } catch (e) {
    btn.textContent = '‚Üª Sync Status';
    btn.disabled = false;
  }
}

  function copyLink(teamId) {
    const text = document.getElementById('link-' + teamId).textContent;
    navigator.clipboard.writeText(text).then(function() {
      document.getElementById('copied-' + teamId).style.display = 'block';
      setTimeout(function() { document.getElementById('copied-' + teamId).style.display = 'none'; }, 2000);
    });
  }

  function redirectToLogin() {
    sessionStorage.removeItem('wsg_access_token');
    sessionStorage.removeItem('wsg_refresh_token');
    window.location.href = '/';
  }

  document.getElementById('signoutBtn').addEventListener('click', redirectToLogin);
</script>

</body>
</html>
